#cloud-config
package_update: true
package_upgrade: true
users:
  - name: ubuntu
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin
    home: /home/ubuntu
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCUBo+qnNu5xxM9vfz4C04M36FHxHNrEMdm5TkFj1/SfVtqunlUOeMpu7nFCZZKnX8HYwf/MkjcBiTYAgncxku8grwl6XuW/pcvmb6/ghSIaw4xtRRSzit7omqJ5d8kXB3+Nd1aaMHsjfly4nkaqswhySVXQqr8Hw6DbWVw8jLLVKEE+5NZHY33hJkhJwK4blCllsGpmQaKi1qxjsN0hZOWNK01iJAydwD8t2xJ0NOYbq8Qas5IyPnRN7SPxvEhIP6WLQ6Ym6Dmf8FwNW1cHLTKabgjzt5f/HKUkKS89dPd3fn4nnFli1BOMECGUIvVlOw2pQNri7+04OOfn2FGlqr5 teacher
      - ssh-rsa MIIEpAIBAAKCAQEAtyTN6/tQtiNjTA89gnKWOQUPOZhALTq3SwpPTcB87NYePb2d1DjC7yxDMxOWuUewu5irEJJx4ywngb2sckMizzdQVz1Wb18NEKl8KuPCCXRLff0CDDLEhDO48jt31y02HeqyxbF+HfCavn8mIaNQ6i9vBERYx1EkcFrAzKXSpTHV1OsJOMoC39QRRFIkWckvBNe7+1JqzrNJuhwSiAdwlJyV1LOCpVUERivpBXWeH+KonyvBv4AyK8PrIoHFlZ+4JPvwcdAUO0LUUrah2y3yZsluMqlQxpQES1LzTVHgdAbySlswV3rnFU+e0qHXnifrHrtjVPCoRgF9sismapE39QIDAQABAoIBAQCr/DwEp3UcFg9hlc5FeiXoVf/+LiPWVZVbOstOUL0AC/NKN47HhKZKxF420OZyCAjHoo7CeUPJ+eT/yYbvpmxB+8fOpSNOYwx54S9hd5D4H+Xk4nvRyLsTCx9bGs1nnGV9orFPRWcR5qjqy6ybWiraQMEYWLamNmTpvc/gXrh5t8KOXwWvol+Ij5oWZUUyRvxDlYPaTUmfx77+KtWZcU/JFo9NRl18stMzDuFmG0f0Rexq51Xic5bAmqyRQlV9QGCm+phKg5R/rtjJJBS2wgRVmw9jgRObPHS8gtx/kXd8OjOuuXFhzzjgaQPtZQW7ZBLAWSsXaIGaXK+fKjR9dzUBAoGBAO2hlTRwjOmUCfNfzrByYlf/g29eGWOAZ/+C6cSW34WocuFDyBnZo+ZFXie87wMum2DOfCEfAZzb9RbI9XqLdPQXNnmjE3hJTy3vV54Ei+uc0uJlx93aBmKWg+wHu7xQ0rQqw6hShlgpQzojkYg2R2DJantimfFsMHH6pgLJJWP5AoGBAMVM/DuMEtcplZg6K9HHvOZ740r7/a3nGK5BRZbmlBAVO85wjP2ykQFcRghopuRaedNPFvuIQz7Or+1Ki27hemgLqVCVlYNF9lfryWCR0kPrm8/sn/8rLij5KU4CNYI4oKBR6zB0OykyHzXFFtHIig+n5KzHGNCYZq8oUk9bn7rdAoGAUc+2kbZKHUS1ZE/Q1hibWRaEBryL2yDjLSnCF8elrtt+qaVvZ87xSZ8KOn4mf571KZANVk3ZfUqRB8YqFYWbv0manKgTVO9QTk0/igygq35zcDSAahXc6uZNBt7muH/O+u5aLEI1NHcISSTjvtSJIH5XpaEdxOtthmA39W+Q6ukCgYBtwr1Tt0JH9rdlP39fLhoVsvgon/VpiHW/g0pef5oBNH7YAt88x9lJg3bmeKnXwcmiV452kkCusTdH8D+PiNqbBVnFHeJWbFZ2ZRLbqWPrKyi8TGxZ/UCpxKtI3Yu9DRm29ru7cf3zlhGszR87x6+etA1QXVadvRrq+KiJw3Qh9QKBgQC1CYuH8flZJlzC3md6NceTzqQ5dwRxaCOY7bGOZyHjdV/O3j3dzQdyxvhrHdL4BIq5qGaT03UmuNlw4dAEpCVE024BN69TvoZtaQFtgixZpKtFikgKt/Kc5KEk8Ul7+/K5HtzD5TlWSKSm9qwXt638aT8id64zrAn5XiIHtXPuSQ==
groups:
  - docker
system_info:
  default_user:
    groups: [docker]
packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - unattended-upgrades

write_files:
  - path: /home/ubuntu/docker-compose.yml
    permissions: '0644'
    content: |
      version: '3.8'
      services:
        m347-kn04a-db:
          image: mariadb:latest
          container_name: m347-kn04a-db
          environment:
            MYSQL_ROOT_PASSWORD: rootpass
            MYSQL_DATABASE: testdb
            MYSQL_USER: testuser
            MYSQL_PASSWORD: testpass
          networks:
            kn04-net:
              ipv4_address: 172.50.5.10

        m347-kn04a-web:
          image: silvanhahn/webserver-kn04a:latest
          container_name: m347-kn04a-web
          ports:
            - "80:80"
          depends_on:
            - m347-kn04a-db
          networks:
            kn04-net:
              ipv4_address: 172.50.5.11

      networks:
        kn04-net:
          driver: bridge
          ipam:
            config:
              - subnet: 172.50.0.0/16
                ip_range: 172.50.5.0/24
                gateway: 172.50.5.254

runcmd:
  - mkdir -p /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
  - curl -L "https://github.com/docker/compose/releases/download/v2.23.3/docker-compose-linux-x86_64" -o /usr/local/bin/docker-compose
  - chmod +x /usr/local/bin/docker-compose
  - docker-compose -f /home/ubuntu/docker-compose.yml up -d

final_message: "Docker Compose Setup abgeschlossen!"
